"""
初始化知识库脚本
将内置知识导入向量数据库，同时构建 GraphRAG 图谱
"""
import sys
import os
from pathlib import Path

# 添加 backend-rag 到路径
sys.path.insert(0, str(Path(__file__).parent.parent))

import json
from datetime import datetime


# 内置知识库数据
INITIAL_KNOWLEDGE = {
    "shared": {
        "basic": [
            {
                "id": "shared-001",
                "title": "五行理论",
                "content": """五行是中国古代哲学的核心概念，包括金、木、水、火、土五种基本元素。

【五行相生】
木生火：木柴燃烧产生火
火生火：火焰燃烧后留下灰烬变成土
土生金：金属从矿石中提炼
金生水：金属表面凝结水珠
水生木：水分滋养植物生长

【五行相克】
木克土：树根穿透土壤
土克水：土堤阻挡水流
水克火：水能浇灭火
火克金：火能熔化金属
金克木：斧头砍伐树木

【五行特性】
木：代表生长、条达、仁慈
火：代表炎热、向上、礼节
土：代表承载、生化、诚信
金：代表清洁、收敛、义气
水：代表寒冷、向下、智慧""",
                "keywords": ["五行", "相生", "相克", "金", "木", "水", "火", "土"]
            },
            {
                "id": "shared-002",
                "title": "天干地支基础",
                "content": """天干地支是中国古代用于计时、计日、计月、计年的符号系统。

【十天干】
甲、乙、丙、丁、戊、己、庚、辛、壬、癸

【十二地支】
子、丑、寅、卯、辰、巳、午、未、申、酉、戌、亥

【干支纪年】
天干与地支依次组合，60年为一个周期（六十甲子）
例如：2024年是甲辰年，2025年是乙巳年

【干支五行属性】
天干：甲乙属木，丙丁属火，戊己属土，庚辛属金，壬癸属水
地支：寅卯属木，巳午属火，申酉属金，亥子属水，辰戌丑未属土

【六合】
子丑合、寅亥合、卯戌合、辰酉合、巳申合、午未合

【三合】
申子辰合水、亥卯未合木、寅午戌合火、巳酉丑合金""",
                "keywords": ["天干", "地支", "干支", "六合", "三合", "六十甲子"]
            },
        ]
    },
    "ziwei": {
        "palace": [
            {
                "id": "ziwei-palace-001",
                "title": "十二宫位总论",
                "content": """紫微斗数将人生分为十二个宫位，分别代表不同的人生领域。

【十二宫位详解】
1. 命宫：先天运势、性格特征、本质
2. 兄弟宫：兄弟姐妹关系、朋友助力
3. 夫妻宫：婚姻感情、配偶情况
4. 子女宫：子女缘分、教育方式
5. 财帛宫：财运、赚钱方式、理财观念
6. 疾厄宫：健康状况、容易得的疾病
7. 迁移宫：外出发展、贵人相助
8. 仆役宫：人际关系、下属同事
9. 官禄宫：事业运势、职场发展
10. 田宅宫：不动产、家庭环境、祖业
11. 福德宫：福分、享受、兴趣爱好
12. 父母宫：父母关系、长辈缘分、学历

【宫位分析原则】
- 每个宫位都要看主星、四化、辅星的配合
- 宫位之间相互影响，要注意生克关系
- 重点宫位需要综合分析多个相关宫位""",
                "keywords": ["十二宫位", "命宫", "官禄宫", "财帛宫", "夫妻宫", "疾厄宫"]
            },
            {
                "id": "ziwei-palace-002",
                "title": "命宫详解",
                "content": """命宫是紫微斗数最重要的宫位，代表先天命运和性格本质。

【命宫的核心意义】
1. 先天禀赋：出生时带来的命运特质
2. 性格特征：为人处世的风格
3. 人生主线：一生发展的主要方向
4. 外在表现：给人的第一印象

【命宫主星】
命宫有主星坐守时，以主星的特性为主要参考
- 紫微星：尊贵、领导力强
- 天机星：聪明、善思考
- 太阳星：热情、开朗、慷慨
- 武曲星：刚毅、财富导向
- 天同星：温和、享乐

【命宫无主星】
需要借对宫（迁移宫）的星曜来看
同时参考身宫的星曜

【四化对命宫的影响】
- 化禄：增强吉运
- 化权：增强掌控力
- 化科：增强贵人运
- 化忌：增加困扰和考验""",
                "keywords": ["命宫", "先天禀赋", "性格", "主星", "四化"]
            },
            {
                "id": "ziwei-palace-003",
                "title": "官禄宫详解",
                "content": """官禄宫主管事业运势和职场发展。

【官禄宫的核心意义】
1. 事业发展：适合的职业类型
2. 工作运势：职场表现和成就
3. 上司关系：与领导长辈的互动
4. 学历功名：考试运势、学术成就

【官禄宫主星分析】
- 紫微星在官禄：适合管理阶层、公职
- 武曲星在官禄：适合财务、金融、商业
- 太阳星在官禄：适合服务行业、公众事务
- 天机星在官禄：适合策划、咨询、技术
- 天同星在官禄：适合稳定工作、不宜创业

【官禄宫四化】
- 化禄：事业顺利、财运亨通
- 化权：权力增大、掌控欲强
- 化科：贵人相助、名声好
- 化忌：事业受阻、小人是非

【官禄宫与财帛宫的关系】
两宫相会，有"财官双美"的可能""",
                "keywords": ["官禄宫", "事业", "工作", "职场", "功名"]
            },
        ],
        "star": [
            {
                "id": "ziwei-star-001",
                "title": "十四主星概述",
                "content": """紫微斗数有十四颗主星，是命盘分析的核心。

【十四主星分类】
1. 正曜：紫微、天机、太阳、武曲、天同、廉贞
2. 辅曜：天府、天相、天梁、天七杀、破军
3. 杂曜：文昌、文曲、左辅、右弼、天魁、天钺、禄存、天马

【主星亮度等级】
- 庙：星曜能量最强
- 旺：星曜能量较强
- 利益：星曜能量一般
- 平和：星曜能量较弱
- 不得：星曜能量最弱
- 陷：星曜能量最弱

【主星与五行】
- 属土：紫微、天府、天梁
- 属木：天机、天同
- 属火：太阳、廉贞
- 属金：武曲、七杀
- 属水：太阴、贪狼、破军
- 属阴土：天相
- 属阴金：巨门""",
                "keywords": ["十四主星", "主星", "亮度", "五行"]
            },
            {
                "id": "ziwei-star-002",
                "title": "紫微星详解",
                "content": """紫微星是北斗星系之首，象征帝王、尊贵、权威。

【紫微星特性】
- 五行属阴土
- 性格：稳重、尊贵、领导力强、有野心
- 优点：高贵优雅、心地宽厚、重情重义
- 缺点：好大喜功、缺乏幽默感、刚愎自用

【紫微星在各宫位】
- 命宫：性格沉稳，有领导才能
- 官禄宫：适合管理阶层
- 财帛宫：财运较好，但理财能力一般
- 夫妻宫：晚婚为宜，对象条件好

【紫微星四化】
- 化禄：增强贵人运和财运
- 化权：增强领导力和掌控欲
- 化科：增强名声和贵人缘
- 化忌：增加困扰，可能怀才不遇

【紫微星与其他星曜的组合】
- 紫微天府：紫府同宫格，贵不可言
- 紫微天相：有辅佐之力，格局较高
- 紫微破军：开创力强，变动较大""",
                "keywords": ["紫微星", "北斗", "帝王", "领导", "尊贵"]
            },
            {
                "id": "ziwei-star-003",
                "title": "武曲星详解",
                "content": """武曲星是北斗财星，象征财富、刚毅、果断。

【武曲星特性】
- 五行属阴金
- 性格：刚毅果断、理财高手、务实
- 优点：财运好、能力强、善于投资
- 缺点：过于功利、缺乏情趣、不善表达感情

【武曲星在各宫位】
- 命宫：理财能力强，适合金融、财务
- 财帛宫：财运极佳，赚钱能力突出
- 官禄宫：适合商业、金融、技术
- 夫妻宫：晚婚为宜，财务观念不同易生分歧

【武曲星四化】
- 化禄：财运大增，投资获利
- 化权：理财能力增强，可能过于节俭
- 化科：财运平稳，贵人相助
- 化忌：财务问题，投资失利

【武曲星与其他星曜的组合】
- 武曲贪狼：财运与桃花俱旺
- 武曲天府：理财高手，财富稳定
- 武曲天相：有贵人相助，财务稳定""",
                "keywords": ["武曲星", "北斗", "财星", "刚毅", "财富"]
            },
        ],
        "transformation": [
            {
                "id": "ziwei-trans-001",
                "title": "四化总论",
                "content": """四化是紫微斗数中最重要的变化因素，包括化禄、化权、化科、化忌。

【四化的来源】
四化由生年天干决定，每个年份都有对应的四化
例如：甲年生人禄在廉贞、权在紫微
      乙年生人禄在天机、权在太阴

【四化的含义】
- 化禄：代表增益、财运、贵人、顺利
- 化权：代表掌控、能力、地位、争执
- 化科：代表名誉、贵人、考试、贵人
- 化忌：代表困扰、执念、缺陷、考验

【四化的作用】
1. 四化会使原本的星曜性质发生改变
2. 化禄化权化科多为吉化，化忌为凶化
3. 四化会引发连锁反应，影响多个宫位
4. 重点宫位遇四化，该方面变化明显

【四化分析原则】
- 首先要确定四化的来源（生年四化或飞星四化）
- 然后看四化落入哪个宫位
- 最后分析四化对宫内星曜的影响""",
                "keywords": ["四化", "化禄", "化权", "化科", "化忌"]
            },
            {
                "id": "ziwei-trans-002",
                "title": "化禄的作用",
                "content": """化禄是四化中最吉利的因素，象征增益和顺利。

【化禄的核心含义】
1. 财运增益：意外之财、投资获利
2. 贵人相助：遇到帮助你的人
3. 运势提升：各个方面都比较顺利
4. 机会增多：好的机遇出现

【化禄在各宫位的影响】
- 命宫：一生运势较好，有贵人相助
- 财帛宫：财运旺盛，钱财源源不断
- 官禄宫：事业顺利，晋升有望
- 夫妻宫：感情甜蜜，对象有财运
- 疾厄宫：身体健康恢复力强

【化禄与其他星曜】
- 禄存+化禄：双禄临命，财运极好
- 化禄+化权：禄权相会，富贵双全
- 化禄+化科：禄科并至，名利双收
- 化禄+化忌：吉中藏凶，需防小人

【化禄的注意事项】
化禄虽吉，但不宜过分依赖，要懂得惜福""",
                "keywords": ["化禄", "财运", "贵人", "增益"]
            },
            {
                "id": "ziwei-trans-003",
                "title": "化忌的作用",
                "content": """化忌是四化中代表困扰和考验的因素。

【化忌的核心含义】
1. 困扰：遇到麻烦和困难
2. 执念：对某些事情过于执着
3. 缺陷：某方面的不足
4. 考验：需要克服的困难

【化忌在各宫位的影响】
- 命宫：一生较多波折，需要努力克服
- 财帛宫：理财困难，投资易失利
- 官禄宫：事业受阻，小人是非多
- 夫妻宫：感情困扰，可能有感情创伤
- 疾厄宫：慢性疾病，需要长期调养

【化忌与其他星曜】
- 化忌+庙旺星：虽有困扰但能化解
- 化忌+陷地星：困扰较大，需特别留意
- 化忌+四化：情况复杂，需要综合分析
- 化忌在命宫：先苦后甜，大器晚成

【化忌的正面意义】
化忌虽然带来困扰，但也代表：
1. 磨练意志，让人更加坚强
2. 经验教训，让人更加成熟
3. 执着追求，让人更有动力""",
                "keywords": ["化忌", "困扰", "考验", "波折"]
            },
        ],
        "fortune": [
            {
                "id": "ziwei-fortune-001",
                "title": "财运分析要点",
                "content": """分析财运需要综合看财帛宫、禄存、化禄、四化等因素。

【看财帛宫】
1. 财帛宫的主星：决定赚钱方式和财运类型
   - 武曲、太阴：财运较好，善于理财
   - 天同、贪狼：桃花财运，需防小人
   - 太阳：开源节流，勤劳致富

2. 财帛宫的四化：
   - 化禄：财运亨通，意外之财
   - 化权：理财能力增强
   - 化科：财运平稳
   - 化忌：财务困扰

【看禄存星】
禄存是财星之首，看财运必看禄存
- 禄存在命宫/财帛宫：财运较好
- 禄存与化禄同宫：双禄临命

【看大运流年】
- 大运财帛宫：十年财运走向
- 流年财帛宫：当年财运好坏
- 遇禄存/化禄/化科：财运较好
- 遇化忌/七杀：需防财务风险

【理财建议】
- 武曲型：适合稳健投资
- 贪狼型：适合多元化投资
- 太阳型：适合实体产业""",
                "keywords": ["财运", "财帛宫", "禄存", "化禄", "理财"]
            },
        ],
        "pattern": [
            {
                "id": "ziwei-pattern-001",
                "title": "紫微斗数主要格局",
                "content": """格局是紫微斗数中星曜组合形成的重要模式。

【紫府同宫格】
- 条件：紫微天府同宫在寅申
- 特点：为人聪明沉稳，有领导才能，一生贵人多助
- 注意：需四化配合才能发挥最大潜力

【杀破狼格】
- 条件：七杀、破军、贪狼在命宫或三方四正
- 特点：开创力强，变动大，人生大起大落
- 注意：适合创业，不适合守成

【火贪格/铃贪格】
- 条件：贪狼星与火星或铃星同宫
- 特点：横财运好，可能有意外之财
- 注意：来得快去得也快

【府相朝垣格】
- 条件：天府、天相在丑未宫，与命宫三方四正相会
- 特点：格局较高，有地位有权力

【日丽中天格】
- 条件：太阳在午宫独坐
- 特点：事业运势极好，贵人多助

【格局分析原则】
1. 格局需要配合四化才能发挥作用
2. 格局好不等于运势好，还需要大运配合
3. 格局差可以通过后天努力改善""",
                "keywords": ["格局", "紫府同宫", "杀破狼", "火贪格"]
            },
        ]
    },
    "bazi": {
        "structure": [
            {
                "id": "bazi-structure-001",
                "title": "八字格局概论",
                "content": """格局是八字分析的核心框架，反映命主的整体特征。

【正格】
指日主得令、得地、有根有气的格局
- 正官格：官星为用，事业为主
- 七杀格：七杀为用，权威为主
- 正财格：财星为用，财富为主
- 偏财格：偏财为用，投机为主
- 正印格：印星为用，学术为主
- 偏印格：偏印为用，技艺为主
- 食神格：食神为用，泄秀为主
- 伤官格：伤官为用，创意为主
- 羊刃格：羊刃为用，武职为主

【从格】
指日主极弱或极强，需要顺从的格局
- 从财格：日主极弱，顺从财星
- 从官杀格：日主极弱，顺从官杀
- 从儿格：日主极弱，顺从食伤
- 从势格：日主极弱，顺从势旺的一方

【化格】
指天干五合形成的特殊格局
- 化金：甲己合化土
- 化木：乙庚合化金
- 化水：丙辛合化水
- 化火：丁壬合化木
- 化土：戊癸合化火

【格局分析要点】
1. 首先判断日主强弱
2. 然后确定格局高低
3. 最后分析用神喜忌""",
                "keywords": ["格局", "正格", "从格", "化格", "正官", "七杀"]
            },
            {
                "id": "bazi-structure-002",
                "title": "从格分析",
                "content": """从格是八字中特殊但常见的格局类型。

【从格的判断】
日主在月令不得令，且其他干支支持力极弱时
如果日主有微薄根气，但整体配合需要顺从，则为从格

【从财格】
- 条件：日主极弱，财星极旺
- 特点：财运较好，但可能身弱不担财
- 喜忌：喜食伤生财，忌比劫克财
- 职业：适合金融、投资、艺术

【从官杀格】
- 条件：日主极弱，官杀极旺
- 特点：权力欲强，但可能过于追求地位
- 喜忌：喜财星生官，忌印星泄官
- 职业：适合管理、政治、法律

【从儿格】
- 条件：日主极弱，食伤极旺
- 特点：聪明伶俐，口才出众
- 喜忌：喜财星生儿，忌印星制食
- 职业：适合教育、演艺、创意

【从势格】
- 条件：日主极弱，无明显主导力量
- 特点：善于察言观色，适应力强
- 喜忌：需要顺势而行

【从格注意事项】
1. 从格需要地支有根才能成立
2. 从格一旦破格，运势会大起大落
3. 从格适合顺势而为，不宜强行自主""",
                "keywords": ["从格", "从财格", "从官杀格", "从儿格"]
            },
        ],
        "yongshen": [
            {
                "id": "bazi-yongshen-001",
                "title": "用神概论",
                "content": """用神是八字分析中最重要的概念，决定命局的吉凶。

【用神的定义】
用神是八字中最需要的那个字
它能调合命局、弥补缺陷、平衡五行

【用神的分类】
1. 调候用神：调节八字寒暖燥湿
2. 格局用神：维护格局成立
3. 病药用神：治疗八字的问题
4. 身用神：平衡日主强弱

【如何确定用神】
1. 分析日主强弱
   - 日主旺：需要克泄耗
   - 日主弱：需要生扶

2. 分析八字结构
   - 找出八字中的问题（病）
   - 找出解决问题的字（药）

3. 综合判断
   - 优先考虑调候用神
   - 然后考虑格局用神
   - 最后考虑平衡用神

【用神与四柱】
年柱用神：影响早年运势
月柱用神：影响青年运势
日柱用神：影响中年运势
时柱用神：影响晚年运势

【用神的变化】
用神在不同大运流年可能会有变化
需要结合大运综合分析""",
                "keywords": ["用神", "调候", "病药", "平衡"]
            },
            {
                "id": "bazi-yongshen-002",
                "title": "身强身弱与用神",
                "content": """判断身强身弱是确定用神的基础。

【身强的判断】
1. 月令得生：日主在月支得令
2. 通根透干：日主在地支有根，天干有同类
3. 印比众多：八字中印星比劫多

【身强的特点】
- 性格：自信、独立、有主见
- 事业：适合独立创业
- 财运：能担财但理财能力一般
- 健康：体质较好

【身弱的判断】
1. 月令失令：日主在月支失令
2. 无根无气：日主在地支无根，天干无同类
3. 官杀克身：官杀多且有力

【身弱的特点】
- 性格：依赖、敏感、缺乏自信
- 事业：适合稳定工作
- 财运：理财能力强但赚钱辛苦
- 健康：需要调养

【身强用神】
- 官杀：克身制身
- 食伤：泄身吐秀
- 财星：耗身生官

【身弱用神】
- 印星：生身化杀
- 比劫：帮身抗杀

【特殊情况的处理】
1. 身弱从格：用神变为从势之神
2. 身强从格：用神变为克泄耗之神""",
                "keywords": ["身强", "身弱", "用神", "日主"]
            },
        ],
        "ten_gods": [
            {
                "id": "bazi-tengods-001",
                "title": "十神详解",
                "content": """十神是八字中分析六亲关系和性格特征的重要工具。

【十神生克关系】
       我   生我   我克   克我   同类
       日主  印星   财星   官杀   比劫

【正印】
- 定义：异性相生
- 代表：母亲、学历、证书、房产
- 性格：善良、包容、有修养
- 特点：生身之物，不可太旺或太弱

【偏印】
- 定义：同性相生
- 代表：继母、技艺、长辈
- 性格：精明、敏感、有心机
- 特点：容易夺食，需要注意

【正财】
- 定义：异性相克
- 代表：妻子、钱财、工作
- 性格：务实、稳重、守财
- 特点：日主所克，适度为佳

【偏财】
- 定义：同性相克
- 代表：父亲、意外之财、横财
- 性格：慷慨、灵活、花心
- 特点：来得快去得也快

【正官】
- 定义：异性相克
- 代表：丈夫、领导、名誉、法律
- 性格：正直、有责任感、守规矩
- 特点：克身有制为贵

【七杀】
- 定义：同性相克
- 代表：小人、压力、权力、武职
- 性格：果断、严厉、有魄力
- 特点：攻身无情，需要制化

【比肩】
- 定义：同类相助
- 代表：兄弟、朋友、合伙人
- 性格：自信、独立、好胜
- 特点：与日主同类，能帮身也能分财

【劫财】
- 定义：同类相争
- 代表：姐妹、竞争者、异性朋友
- 性格：冲动、好斗、投机
- 特点：容易破财，需要控制

【食神】
- 定义：异性相泄
- 代表：女儿、才华、技艺、口福
- 性格：聪明、温和、有艺术天赋
- 特点：泄秀生财，福气之星

【伤官】
- 定义：同性相泄
- 代表：儿子、创意、才华、叛逆
- 性格：聪明、才华、叛逆、不受约束
- 特点：需要管束，否则闯祸""",
                "keywords": ["十神", "正印", "正财", "正官", "食神"]
            },
        ],
    }
}


def init_knowledge():
    """初始化知识库"""
    print("开始初始化知识库...")
    print("=" * 50)

    # 导入必要的模块
    from app.services.rag_engine import get_rag_engine
    import asyncio

    engine = get_rag_engine()

    total_entries = 0

    for destiny_type, categories in INITIAL_KNOWLEDGE.items():
        for category, entries in categories.items():
            print(f"\n索引 {destiny_type}/{category}: {len(entries)} 条目")

            documents = []
            for entry in entries:
                doc = {
                    "id": entry["id"],
                    "title": entry["title"],
                    "content": entry["content"],
                    "level": "method",
                    "destiny_type": destiny_type,
                    "category": category,
                    "source_type": "manual",
                    "keywords": entry.get("keywords", []),
                    "entities": [],
                }
                documents.append(doc)

            # 索引文档
            asyncio.run(engine.retriever.index(
                destiny_type=destiny_type,
                category=category,
                documents=documents
            ))

            total_entries += len(documents)
            print(f"  ✓ 完成")

    print("\n" + "=" * 50)
    print(f"知识库初始化完成！共索引 {total_entries} 条知识")
    print("=" * 50)


if __name__ == "__main__":
    init_knowledge()
