/**
 * 八字命理 - 家庭亲缘知识库
 */

import type { KnowledgeEntry } from '../../types/index.js';

export const familyKnowledge: KnowledgeEntry[] = [
  {
    id: 'bazi-family-1',
    destinyType: 'bazi',
    subCategory: 'family',
    title: '六亲星看家庭关系',
    content: `【八字六亲对应】
父亲：男命看偏财，女命看偏财（部分学派看正财）
母亲：男命看正印，女命看正印
兄弟：男命看比肩（同性），女命看比肩
姐妹：男命看劫财，女命看劫财
子女：男命看食神（女儿）、伤官（儿子）；女命看食神（女儿）、伤官（儿子）
子孙：时柱为晚年、子孙

【星旺与亲缘】
六亲星旺且有力：与该亲属关系好，对方有助力。
六亲星弱被克：与该亲属缘分浅薄，或该亲属身体较弱。
六亲星入墓：与该亲属关系深沉内敛，或对方早离（辰戌丑未）。

【父母宫与兄弟宫】
年柱代表祖辈与早年家庭背景。
月柱代表父母（尤其父母宫）、兄弟姐妹。
月令财星旺：父亲富裕，家庭物质条件好。
月令印星旺：母亲贤慧，早年读书运佳，家庭教育好。`,
    shishen: ['正印', '偏印', '比肩', '劫财', '食神', '伤官', '正财', '偏财'],
    pillars: ['年柱', '月柱', '时柱'],
    keywords: ['家庭', '父亲', '母亲', '兄弟', '姐妹', '子女', '六亲', '亲缘', '父母'],
  },
  {
    id: 'bazi-family-2',
    destinyType: 'bazi',
    subCategory: 'family',
    title: '子女星与子嗣分析',
    content: `【子女星的判断】
男命：食神为女儿，伤官为儿子。
女命：食神为女儿，伤官为儿子。子女星是食伤，也代表女命的才华表达。

【子女缘深浅】
食伤旺且有力：子女缘深，子女聪明有出息。
食伤弱被克（印旺克食伤）：子女缘薄，晚育或子女较难带。
时柱藏食伤：晚年有子女陪伴，晚运较好。
食伤入墓：子女性格内敛，缘分含蓄。

【特殊格局】
枭神夺食（偏印旺克食神）：子女缘较薄，或子女难以成器。
伤官旺（女命）：婚后独立意识强，对生育子女有自己的想法，晚育倾向。
食神旺（女命）：温柔贤淑，爱护子女，适合相夫教子。

【子女运与流年】
食伤流年：子女有喜事，或本人才华被认可。
子女官杀旺年：子女受压力，或自身对子女有管教问题。
冲时支：子女宫受冲，子女与自身关系出现变化。`,
    shishen: ['食神', '伤官', '正印', '偏印'],
    pillars: ['时柱', '日柱'],
    keywords: ['子女', '子嗣', '食神', '伤官', '生育', '子女缘', '晚年', '时柱'],
  },
  {
    id: 'bazi-family-3',
    destinyType: 'bazi',
    subCategory: 'family',
    title: '家庭背景与祖荫分析',
    content: `【年柱与家庭背景】
年干为祖父，年支为祖母（部分学派）。
年柱官印旺：出身官宦或书香门第，家庭背景好。
年柱财旺：出身富裕家庭，早年物质条件佳。
年柱比劫旺：兄弟姐妹多，或家庭中竞争较多。
年柱刑冲：早年家庭不稳定，或幼年与亲人分离。

【月柱与父母影响】
月令印旺：母亲对命主影响深远，教育背景好。
月令财旺：父亲能干，家庭经济条件好。
月令官杀旺：父亲严格，有规矩，家教严格。
月令比劫旺：兄弟姐妹多，家庭中竞争感强。

【离祖与克亲】
年月柱刑冲严重：早年离祖，或与父母聚少离多。
六亲星入库（辰戌丑未）：与六亲感情深沉内敛，或六亲早离。
六亲星死绝：与该六亲缘分浅薄，对方健康较弱或缘分短。`,
    shishen: ['正印', '偏印', '比肩', '劫财', '正官', '七杀'],
    pillars: ['年柱', '月柱'],
    keywords: ['家庭', '祖荫', '父母', '背景', '年柱', '月柱', '出身', '离祖', '家教'],
  },
  {
    id: 'bazi-family-4',
    destinyType: 'bazi',
    subCategory: 'family',
    title: '父星（正印/偏印/七杀）的综合判断',
    content: `【父亲星的多学派对应】
主流派：男命偏财为父，正财为父的辅助说法。
部分学派：七杀也代表父亲（父代表权威与约束，七杀主克制）。
全面分析：综合偏财（父亲的财富）、七杀（父亲的严格）、正印（母亲的教育）来判断家庭对命主的影响。

【偏财（父星）的力量解读】
偏财旺且有力：父亲能干、富裕，家庭物质支持充足。
偏财弱或被比劫夺：父亲财力有限，或家庭中竞争分割，父亲辛苦但难以给予充足支持。
偏财入库（辰戌丑未）：父亲财富有积累，但多暗藏，不外显。
偏财遭冲：父子关系波折，或父亲遭遇变故（财运波动）。

【七杀与父亲关系】
七杀旺且无制（日主弱）：父亲或权威人物对命主管束严格，压力大。
七杀有印化：父亲严格但有爱，管教方式偏于讲理，能为命主增益。
七杀入月令：父亲对命主的人生影响深远，是塑造性格的核心力量。

【正印（母星）的力量解读】
正印旺且有力：母亲贤慧，教育环境好，早年学习成绩佳，母亲对命主正面影响大。
正印弱或被克：母亲体弱或影响力有限，命主较早独立。
正印入墓或遇冲：与母亲感情深沉但聚少离多，或母亲健康需关注。`,
    shishen: ['偏财', '正印', '七杀', '比肩', '劫财'],
    pillars: ['年柱', '月柱'],
    keywords: ['父亲', '父星', '母亲', '正印', '偏财', '七杀', '家庭', '权威', '严格'],
  },
  {
    id: 'bazi-family-5',
    destinyType: 'bazi',
    subCategory: 'family',
    title: '子女星（食神/伤官）与教育及关系',
    content: `【食神与伤官的子女象征】
男命：食神代表女儿（同性同类），伤官代表儿子（异性相生）。
女命：食神代表女儿，伤官代表儿子。同时食伤也代表女命的才华与表达。

【子女与命主的关系质量判断】
食神旺且有力（无印克）：子女聪明乖巧，母慈子孝，亲子关系融洽。
伤官旺（女命）：子女个性独立甚至叛逆，亲子需要相互理解与空间。
印旺克食伤（枭神夺食）：子女缘薄，或子女早年健康问题，晚育为宜。
食伤被冲克：子女成长路途多波折，或子女与自身关系不够紧密。

【教育子女的命局提示】
食神格命主：天生具备耐心，适合温和引导型教育方式。
伤官格命主：思维创新，对子女也偏向开放式自由教育。
正印旺命主：重视子女学历与传统教育，偏向严格学业要求。
偏印旺命主：对子女有独特期待，可能走艺术或非传统路线。

【亲子关系流年预测】
食伤流年：子女有喜事或突破，亲子关系活跃。
时支遭冲流年：子女宫有变动，需关注子女状态。
印旺流年：命主专注自身，对子女投入可能减少。`,
    shishen: ['食神', '伤官', '正印', '偏印', '比肩', '劫财'],
    pillars: ['时柱', '日柱'],
    keywords: ['子女', '食神', '伤官', '教育', '亲子关系', '子女缘', '流年', '子女星'],
  },
];

export function retrieve(chartText: string, query: string): KnowledgeEntry[] {
  const keywords = extractKeywords(chartText + ' ' + query);
  return familyKnowledge
    .filter(e => matchKeywords(e, keywords))
    .slice(0, 5);
}

export const entries = familyKnowledge;

function extractKeywords(text: string): string[] {
  return [
    '家庭', '父亲', '母亲', '兄弟', '姐妹', '子女', '六亲', '亲缘',
    '父母', '子嗣', '祖荫', '背景', '年柱', '月柱', '时柱',
  ].filter(k => text.includes(k));
}

function matchKeywords(entry: KnowledgeEntry, keywords: string[]): boolean {
  if (keywords.length === 0) return true;
  return keywords.some(kw =>
    entry.keywords.includes(kw) || entry.content.includes(kw) || entry.title.includes(kw)
  );
}
