/**
 * 八字命理 - 健康运势知识库
 */

import type { KnowledgeEntry } from '../../types/index.js';

export const healthKnowledge: KnowledgeEntry[] = [
  {
    id: 'bazi-health-1',
    destinyType: 'bazi',
    subCategory: 'health',
    title: '五行与身体器官对应',
    content: `【五行对应人体】
木：肝脏、胆囊、神经系统、筋骨、眼睛
火：心脏、小肠、血液循环、视力
土：脾脏、胃、消化系统、肌肉
金：肺脏、大肠、呼吸系统、皮肤、鼻子
水：肾脏、膀胱、泌尿生殖系统、耳朵、骨骼

【判断方法】
命中五行过旺（超过3个）：对应器官易亢奋或过劳。
命中五行过弱（0个）：对应器官先天较弱，需注意保养。
五行被克：被克五行对应的器官健康风险较高。

【实例】
命中土旺克水：脾胃强但肾脏偏弱，需注意肾脏保养。
命中金旺克木：呼吸系统有优势但肝胆偏弱，注意情绪管理。
命中木旺克土：肝胆旺盛但脾胃消化功能偏弱。`,
    wuxing: ['木', '火', '土', '金', '水'],
    keywords: ['健康', '五行', '器官', '肝脏', '心脏', '脾胃', '肺', '肾', '身体'],
  },
  {
    id: 'bazi-health-2',
    destinyType: 'bazi',
    subCategory: 'health',
    title: '十神与健康关联',
    content: `【十神对健康的影响】
正印、偏印旺：大脑活跃，思虑过多，易失眠、神经衰弱。
比肩、劫财旺：精力充沛，但争强好胜，易受外伤。
食神旺：消化好，体质较好，但易贪嘴导致肠胃问题。
伤官旺：精神外泄，情绪波动大，易有肝气郁结。
正财、偏财旺：操劳奔波，易过劳，财运好但健康需关注。
正官、七杀旺（日主弱）：压力大，易因压力引发疾病；七杀过旺主伤灾。

【特殊格局与健康】
枭神夺食（偏印克食神）：消化系统问题，免疫力偏弱。
伤官见官（格局不合）：紧张焦虑，职场压力影响身心。
比劫旺而无制：血气方刚，外伤风险，需注意安全。

【大运健康变化】
行克日主五行的大运：健康挑战期，需定期体检。
行喜用神大运：精气神充沛，健康状态改善。`,
    shishen: ['正印', '偏印', '比肩', '劫财', '食神', '伤官', '正财', '偏财', '正官', '七杀'],
    keywords: ['健康', '十神', '疾病', '失眠', '压力', '外伤', '体质', '大运'],
  },
  {
    id: 'bazi-health-3',
    destinyType: 'bazi',
    subCategory: 'health',
    title: '健康风险大运流年判断',
    content: `【高风险大运特征】
克日主的大运：日主被克，整体健康下滑，容易生病。
七杀旺且无制的大运：意外伤灾风险，男性尤须注意。
官杀混杂的大运：压力过大导致慢性病。
比劫旺的大运：兄弟竞争，竞争激烈导致劳神伤身。

【健康流年信号】
流年干支克日柱：当年健康挑战，注意重大疾病筛查。
流年冲日支：配偶宫受冲，身体抵抗力下降。
流年合住喜用神（合去喜用）：健康失去保护，需注意。
流年带刑（寅巳申三刑、子卯相刑等）：外伤或手术机率增高。

【养生建议方向】
木弱者：保肝护胆，调节情绪，避免熬夜。
火弱者：保护心血管，注意心脏健康，适当运动。
土弱者：规律饮食，保护脾胃，忌暴饮暴食。
金弱者：保护呼吸系统，戒烟，关注肺部健康。
水弱者：保肾护腰，注意泌尿系统，补充水分。`,
    wuxing: ['木', '火', '土', '金', '水'],
    keywords: ['健康', '大运', '流年', '疾病', '外伤', '养生', '风险', '体检'],
  },
  {
    id: 'bazi-health-4',
    destinyType: 'bazi',
    subCategory: 'health',
    title: '五行偏枯对应脏腑问题',
    content: `【偏枯概念】
命局中某一五行极多（超过全局40%）或极少（为零），称为偏枯。
偏枯命局健康问题比均衡命局更突出，需重点关注。

【各五行偏枯的脏腑表现】
木极旺（肝木过旺）：
  - 肝火旺、情绪易怒、血压偏高、偏头痛
  - 脾胃受木克，消化系统功能弱

火极旺（心火过旺）：
  - 心悸、失眠、烦躁、口腔溃疡
  - 水受克，肾脏及泌尿系统偏弱

土极旺（脾土过旺）：
  - 消化系统过于保守（腹胀、痰湿）、代谢缓慢
  - 肾水受克，泌尿与内分泌系统偏弱

金极旺（肺金过旺）：
  - 呼吸系统敏感、皮肤问题、大肠功能过强
  - 肝木受克，情绪压抑、筋骨问题

水极旺（肾水过旺）：
  - 泌尿系统问题、体寒、免疫偏低
  - 心火受克，心脏功能弱、抑郁倾向

【调养建议】
对应五行过旺时，宜培养其所克五行的脏腑。
例：木旺克土，宜养脾胃，饮食规律，避免肝火上炎的食物（辛辣）。`,
    wuxing: ['木', '火', '土', '金', '水'],
    keywords: ['五行偏枯', '脏腑', '偏旺', '偏弱', '肝火', '心火', '脾土', '肺金', '肾水'],
  },
  {
    id: 'bazi-health-5',
    destinyType: 'bazi',
    subCategory: 'health',
    title: '大运克日主的健康窗口',
    content: `【大运克日主的识别】
日主五行：甲乙木、丙丁火、戊己土、庚辛金、壬癸水
克日主大运：行克日主五行的大运（如日主木，行金运则金克木）

【大运克日主的健康影响】
轻度克制（大运克日主，但日主有根）：该10年压力较大，心理负担重，易因劳累诱发慢性病。
重度克制（大运克日主，且日主无根）：该10年可能出现较严重疾病，需提前健康筛查。
七杀大运（最强克制）：意外伤灾、重大手术、慢性病爆发风险，男性尤为明显。

【健康窗口判断三步法】
第一步：确认大运天干地支是否克日主五行
第二步：结合流年看是否双重叠加（大运克+流年克=最高风险）
第三步：看命局是否有印星化解（印转克为生，缓解伤害）

【预防与调养】
提前3年做健康检查，建立健康档案。
该大运中：减少高风险活动（极限运动、高强度工作）。
增强免疫：用神五行对应的食物与生活方式调理。
若七杀大运而日主极弱：考虑外科手术检查，主动防御。`,
    wuxing: ['木', '火', '土', '金', '水'],
    keywords: ['大运', '克日主', '健康窗口', '七杀', '疾病', '慢性病', '外伤', '预防'],
  },
];

export function retrieve(chartText: string, query: string): KnowledgeEntry[] {
  const keywords = extractKeywords(chartText + ' ' + query);
  return healthKnowledge
    .filter(e => matchKeywords(e, keywords))
    .slice(0, 5);
}

export const entries = healthKnowledge;

function extractKeywords(text: string): string[] {
  return [
    '健康', '疾病', '五行', '器官', '大运', '流年', '养生', '外伤',
    '失眠', '压力', '体质', '肝', '心', '脾', '肺', '肾',
  ].filter(k => text.includes(k));
}

function matchKeywords(entry: KnowledgeEntry, keywords: string[]): boolean {
  if (keywords.length === 0) return true;
  return keywords.some(kw =>
    entry.keywords.includes(kw) || entry.content.includes(kw) || entry.title.includes(kw)
  );
}
