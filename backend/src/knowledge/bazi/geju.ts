/**
 * 八字命理 - 格局知识库
 */

import type { KnowledgeEntry } from '../../types/index.js';

export const gejuKnowledge: KnowledgeEntry[] = [
  {
    id: 'bazi-geju-1',
    destinyType: 'bazi',
    subCategory: 'geju',
    title: '八字普通格局（月令格局）详解',
    content: `【普通格局取格方法】
以月令天干的十神关系为主要格局名称：
正官格：月干为正官，有官无杀，适合仕途，做事守法循规。
七杀格：月干为七杀，有魄力执行力，但脾气急，需食神制杀。
正印格：月干为正印，学识丰富，适合学术或文职，保守慷慨。
偏印格（枭神）：月干为偏印，思维独特，才艺多，但执行力不足。
正财格：月干为正财，踏实稳健，理财能力强，适合稳定工作。
偏财格：月干为偏财，交际广，适合投机或生意，但财来财去。
食神格：月干为食神，才华横溢，贵人多，乐观知足，寿命较长。
伤官格：月干为伤官，聪明叛逆，创意丰富，但不服管教，仕途阻。
建禄格：月令为日主本气，身旺，白手起家，靠自身努力。

【格局优劣判断】
格局成立：格神（月令之神）透干且有根，无破坏。
格局被破：格神被冲克合去，运途多阻。
格局升级：格神强旺，用神配合，行有利大运，命格提升。`,
    shishen: ['正官', '七杀', '正印', '偏印', '正财', '偏财', '食神', '伤官', '比肩', '劫财'],
    pillars: ['月柱'],
    keywords: ['格局', '月令', '正官格', '七杀格', '正印格', '食神格', '伤官格', '建禄格', '格神'],
  },
  {
    id: 'bazi-geju-2',
    destinyType: 'bazi',
    subCategory: 'geju',
    title: '特殊格局（从格与专旺格）',
    content: `【从格条件与判断】
从格必须满足：日主完全无根（无比印帮扶），命中某种五行极旺。

从财格：四柱财星极旺，无印比护日主。
  特征：行财运、官杀运大吉；忌印比运。
  适合：商界领袖，财运极佳但感情较薄。

从杀格（从官杀格）：四柱官杀极旺，无印比。
  特征：行官杀运、财运大贵；忌比劫印运。
  适合：军政界，有威望，做事雷厉风行。

从儿格（从食伤格）：四柱食伤极旺，无印克。
  特征：行食伤、财运大吉；忌印运克食伤。
  适合：文艺界、教育界，才华出众。

专旺格（从旺格）：四柱全是比劫，一五行独旺。
  特征：行比劫运吉；其余运参差不一。

【从格注意事项】
从格一旦行破格之运（有印比），反而诸事不顺。
从格命人不能用普通喜用神方法判断，需单独处理。
真从格与假从格：有一点点根的是假从格，要具体区分。`,
    shishen: ['正财', '偏财', '正官', '七杀', '食神', '伤官', '比肩', '劫财'],
    keywords: ['从格', '特殊格局', '从财格', '从杀格', '从儿格', '专旺格', '从旺格', '大运'],
  },
  {
    id: 'bazi-geju-3',
    destinyType: 'bazi',
    subCategory: 'geju',
    title: '格局高低与命格层次',
    content: `【命格高低判断维度】
1. 格局是否清纯：格神明透无破坏，用神有力，忌神无力。
2. 大运是否配合：大运能否持续扶助用神？高格局需大运配合才能发挥。
3. 格局与五行均衡：既不太旺又不太弱，中正平和者层次高。
4. 有无贵气：天乙贵人（甲戊庚见牛羊，乙己见鼠猴乡...）提升格局。

【命格层次描述】
上上格（帝王将相格）：格局清纯，用神有根有力，大运长期扶助，少见。
上格（高官富商格）：主要格局清晰，大运大多配合，可成就大业。
中格（普通成功人士）：格局基本成立，大运有好有坏，可小有成就。
下格（平淡命局）：格局不清，用忌混杂，大运多不配合，普通平淡。
困苦格：格局被破，忌神旺，大运持续走忌，生活多波折。

【提升命格的方法】
运时配合：在用神大运年份发力，把握机遇。
合适职业：选择符合命中用神五行的职业方向。
居住环境：五行能量（颜色、方位）辅助命中弱势五行。`,
    shishen: ['正官', '七杀', '正财', '偏财', '食神', '伤官', '正印', '偏印'],
    wuxing: ['木', '火', '土', '金', '水'],
    keywords: ['格局', '命格', '层次', '高低', '清纯', '大运', '贵气', '帝王格', '普通格'],
  },
  {
    id: 'bazi-geju-4',
    destinyType: 'bazi',
    subCategory: 'geju',
    title: '普通格与变格的判断实操',
    content: `【普通格取格步骤】
第一步：看月令地支所藏的天干（人元司令）
第二步：若月令藏干透出天干，则以透出十神定格
第三步：若未透干，则以月令主气（司令之神）定格
第四步：验证格神是否有根有力，确定格局是否成立

【变格的四种核心情形】
从财格：日主极弱，四柱财星极多且无印比护日，顺从财星。
从杀格：四柱官杀极旺，日主完全无根，无印比护日，顺官杀。
从儿格：四柱食伤极旺，无印克食伤，日主顺从食伤。
从旺格（专旺格）：四柱全为比劫，日主独旺，旺极从旺。

【判断普通格还是变格的关键】
日主是否有"一丝通根"：哪怕地支中有一个同气，多数不能成从格。
全局是否有印比护日：有一颗强力印星或比星，通常不能成从格。
变格行运：从财格行财运最吉；从杀格行财官运吉；忌见印比破格。`,
    shishen: ['正财', '偏财', '正官', '七杀', '食神', '伤官', '比肩', '劫财', '正印', '偏印'],
    keywords: ['普通格', '变格', '从格', '判断', '透干', '月令', '日主通根'],
  },
  {
    id: 'bazi-geju-5',
    destinyType: 'bazi',
    subCategory: 'geju',
    title: '格局高低层次与命格升降',
    content: `【格局高低的四个维度】
1. 格局清纯度：格神（月令之神）透干有根、不被冲破，清纯者层次高。
2. 用神有力度：用神根深力旺，且无忌神克制，用神越强格局越高。
3. 大运配合度：命局所需大运是否长期扶助用神，10年、20年均顺则格局高。
4. 五行均衡度：既不偏旺也不偏弱，中正平衡者层次更高。

【命格层次与现实对应】
顶级格局（帝王将相）：罕见，格局清纯，用神力旺，大运全程配合。
高格局（高官富商）：格局基本清晰，大运多顺，可成大业。
中格局（普通成功）：格局基本成立，大运有顺有逆，可小有成就。
低格局（平淡命）：格局模糊或被破，大运多不配合，事倍功半。

【命格升降的实操建议】
格局可因以下因素提升：行用神大运、从事命中喜神五行对应行业、居用神方位。
格局可因以下因素降低：行忌神大运、职业与命局不合、情绪长期消耗正气。`,
    shishen: ['正官', '七杀', '正财', '偏财', '食神', '伤官', '正印', '偏印'],
    wuxing: ['木', '火', '土', '金', '水'],
    keywords: ['格局', '层次', '高低', '清纯', '用神', '大运', '命格升降', '均衡'],
  },
];

export function retrieve(chartText: string, query: string): KnowledgeEntry[] {
  const keywords = extractKeywords(chartText + ' ' + query);
  return gejuKnowledge
    .filter(e => matchKeywords(e, keywords))
    .slice(0, 5);
}

export const entries = gejuKnowledge;

function extractKeywords(text: string): string[] {
  return [
    '格局', '从格', '专旺格', '月令', '格神', '用神', '忌神',
    '清纯', '层次', '大运', '命格', '正官格', '七杀格', '食神格', '伤官格',
  ].filter(k => text.includes(k));
}

function matchKeywords(entry: KnowledgeEntry, keywords: string[]): boolean {
  if (keywords.length === 0) return true;
  return keywords.some(kw =>
    entry.keywords.includes(kw) || entry.content.includes(kw) || entry.title.includes(kw)
  );
}
