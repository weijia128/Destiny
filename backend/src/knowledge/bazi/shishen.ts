/**
 * 八字命理 - 十神分析知识库
 */

import type { KnowledgeEntry } from '../../types/index.js';

export const shishenKnowledge: KnowledgeEntry[] = [
  {
    id: 'bazi-shishen-1',
    destinyType: 'bazi',
    subCategory: 'shishen',
    title: '十神基本含义与性格特征',
    content: `【十神定义】
十神是以日主为基准，根据五行生克与阴阳关系推算出的10种关系，代表命主的性格、能力、人际关系。

【十神性格特征速查表】
比肩（同五行同阴阳）：自立心强，独当一面，有主见，较固执，竞争意识强。
劫财（同五行异阴阳）：有活力，善于协作，但有时过于自我，争夺资源倾向。
食神（日主所生，同阴阳）：乐天随和，聪明善表达，口才好，享乐主义，寿星象。
伤官（日主所生，异阴阳）：聪明叛逆，才华横溢，创意无限，但情绪化，难服管教。
偏财（日主所克，同阴阳）：豪爽大方，广结人脉，活泼机智，但财来财去。
正财（日主所克，异阴阳）：踏实稳健，重诺守信，理财能力强，保守务实。
七杀（克日主，同阴阳）：魄力强，执行力高，但急躁强势，需制化方可发挥。
正官（克日主，异阴阳）：规矩谨慎，有荣誉感，重视社会形象，适合体制内。
偏印（生日主，同阴阳）：思维独特，才艺多样，独立思考，但执行力不足。
正印（生日主，异阴阳）：学识丰厚，慈悲保守，有利于学术，守成型性格。`,
    shishen: ['比肩', '劫财', '食神', '伤官', '偏财', '正财', '七杀', '正官', '偏印', '正印'],
    keywords: ['十神', '性格', '比肩', '劫财', '食神', '伤官', '偏财', '正财', '七杀', '正官', '偏印', '正印'],
  },
  {
    id: 'bazi-shishen-2',
    destinyType: 'bazi',
    subCategory: 'shishen',
    title: '十神组合关系（官印相生、伤官见官等）',
    content: `【吉组合】
官印相生（正官+正印）：官星生印，印生日主，形成"贵气链"，主学历高、仕途顺、有贵人。
食神制杀（食神+七杀）：食神克制七杀，化解凶星为助力，主聪明有能力而化险为夷。
财官双美（财星+正官）：财生官，官为事业，主事业财运双旺，适合高层管理或自主经营。
印比扶日（正印+比肩/劫财）：生助日主，适合日主弱的命局，增强命主的能力与资源。

【凶组合需制化】
伤官见官（伤官+正官）：伤官克官，主感情波折（女命）、仕途受阻，需印星化解。
枭神夺食（偏印克食神）：偏印克食神，主子女缘薄、消化弱、被人夺权，需食神有力。
官杀混杂（正官+七杀同透）：两个克日主的力量混乱，主压力大、责任不清，需制化。
比劫争财（比肩/劫财旺+财星弱）：竞争分财，主合伙纠纷、财不聚，需官制比劫。

【中性组合（需分析日主强弱）】
食神生财：食神生财，才华变现，日主强时吉，日主弱时耗。
印化杀（正印+七杀）：七杀生正印，正印生日主，化凶为贵，主有权威且能成就大事。`,
    shishen: ['正官', '正印', '食神', '七杀', '偏印', '比肩', '劫财', '伤官', '偏财', '正财'],
    keywords: ['十神组合', '官印相生', '食神制杀', '伤官见官', '枭神夺食', '官杀混杂', '比劫争财'],
  },
  {
    id: 'bazi-shishen-3',
    destinyType: 'bazi',
    subCategory: 'shishen',
    title: '十神在流年的触动与应事',
    content: `【流年天干触动命中十神的应事规律】
流年遇比肩/劫财：
  - 与兄弟姐妹、同事、朋友有联动；竞争激烈；财被分割。
  - 适合：合作项目、借助同伴资源。

流年遇食神/伤官：
  - 才华展现机会，创作、表达、输出能力增强；感情有变（女命）。
  - 适合：自我营销、创意项目、公开发表。

流年遇正财/偏财：
  - 财运变动，有收入机会；男命可能有感情变化。
  - 适合：投资布局、业务开拓；男命感情有动态。

流年遇正官/七杀：
  - 社会地位与职场变化；有官位机会（正官年）或压力增大（七杀年）。
  - 适合：申报升职、管理岗位调整；七杀年宜谨慎，防小人。

流年遇正印/偏印：
  - 学习成长机会，贵人出现；但财运受阻（印克食伤生财链）。
  - 适合：考试、资格证、跟随导师学习；暂缓大额投资。

【流年与命局的叠加效应】
流年十神与大运十神相同（叠加）：该年该十神力量最强，对应事件最为明显。
流年克命局用神：该年逆境集中，重大阻碍期。
流年生命局用神：该年顺境助力，重大机遇期。`,
    shishen: ['比肩', '劫财', '食神', '伤官', '正财', '偏财', '正官', '七杀', '正印', '偏印'],
    keywords: ['十神', '流年', '触动', '应事', '大运', '叠加', '感情', '事业', '财运'],
  },
];

export function retrieve(chartText: string, query: string): KnowledgeEntry[] {
  const keywords = extractKeywords(chartText + ' ' + query);
  return shishenKnowledge
    .filter(e => matchKeywords(e, keywords))
    .slice(0, 5);
}

export const entries = shishenKnowledge;

function extractKeywords(text: string): string[] {
  return [
    '十神', '比肩', '劫财', '食神', '伤官', '正财', '偏财',
    '正官', '七杀', '正印', '偏印', '性格', '流年', '组合',
    '官印相生', '食神制杀', '伤官见官', '枭神夺食', '官杀混杂',
  ].filter(k => text.includes(k));
}

function matchKeywords(entry: KnowledgeEntry, keywords: string[]): boolean {
  if (keywords.length === 0) return true;
  return keywords.some(kw =>
    entry.keywords.includes(kw) || entry.content.includes(kw) || entry.title.includes(kw)
  );
}
