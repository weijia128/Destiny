/**
 * 八字命理 - 感情婚姻知识库
 */

import type { KnowledgeEntry } from '../../types/index.js';

export const relationshipKnowledge: KnowledgeEntry[] = [
  {
    id: 'bazi-rel-1',
    destinyType: 'bazi',
    subCategory: 'relationship',
    title: '八字婚姻星分析（男命）',
    content: `【男命看财星为妻】
正财为妻（有情之妻），偏财为情人或妾。
财星旺且日主有力：感情顺利，妻贤且有助力。
财星弱被克：感情挫折，或妻子体弱、婚姻不稳。
财多身弱：异性缘好但难以专一，感情消耗精力。

【男命日支看配偶宫】
日支为配偶宫，其中藏干代表配偶特质：
日支阳刃（午、子、卯、酉）：配偶个性独立、刚强，婚姻需磨合。
日支财星：配偶贤淑，物质条件好。
日支官杀：配偶有地位或才干，但也可能控制欲强。

【特殊情况】
财星入墓（辰戌丑未）：感情深藏，晚婚或感情含蓄。
比劫争财：兄弟姐妹或朋友影响感情，第三者风险。
财官相生：感情与事业相辅相成，得贤妻助力。`,
    pillars: ['日柱', '月柱', '年柱', '时柱'],
    shishen: ['正财', '偏财', '正官', '七杀', '比肩', '劫财'],
    keywords: ['婚姻', '感情', '男命', '妻星', '财星', '配偶', '日支', '恋爱'],
  },
  {
    id: 'bazi-rel-2',
    destinyType: 'bazi',
    subCategory: 'relationship',
    title: '八字婚姻星分析（女命）',
    content: `【女命看官杀为夫】
正官为夫（正式配偶），七杀为情人或同居者。
官星旺且日主有力：婚姻稳定，丈夫有能力。
官杀混杂：感情复杂，易有多段感情或婚姻不稳。
官星弱被克：丈夫能力偏弱，或感情缘分浅薄。

【女命日支看配偶宫】
日支官星：丈夫有地位、有能力，婚姻主动权在对方。
日支食伤：本人独立自主，对感情有自己的想法，易晚婚。
日支比劫：与配偶平起平坐，感情平等但容易因自我而冲突。

【特殊情况】
伤官见官：女命伤官旺，官星受克，感情波折，婚姻不稳。
食神制杀：七杀被食神制化，婚姻反而稳定（化凶为吉）。
官星入库：感情含蓄深沉，晚婚或婚后生活较平淡。
官杀混杂不制：感情复杂，易有婚外情或多次婚姻。`,
    pillars: ['日柱', '月柱'],
    shishen: ['正官', '七杀', '食神', '伤官', '正印', '偏印'],
    keywords: ['婚姻', '感情', '女命', '夫星', '官星', '配偶', '日支', '官杀混杂'],
  },
  {
    id: 'bazi-rel-3',
    destinyType: 'bazi',
    subCategory: 'relationship',
    title: '感情大运流年分析',
    content: `【感情大运规律】
行财运（男）/ 行官运（女）：感情机缘大运，适合恋爱结婚。
行印运：心思内敛，偏重自我成长，感情机缘次之。
行比劫运：竞争激烈，感情出现第三者风险，已婚者需注意。
行食伤运（女）：对婚姻约束有抵触，离婚率较高。

【结婚时机判断】
命中财/官星旺的流年：感情运最旺的年份。
天干合：命中财/官星在流年被合，感情"动"起来。
地支合：日支与流年地支相合，婚姻感情有重要变化。
冲日支：感情、婚姻出现大变动（可能结婚也可能离婚）。

【离婚信号】
官杀混杂年：女命异性缘复杂。
比劫夺财年（男）：第三者出现。
伤官年（女命伤官旺）：对婚姻失望，分离倾向。
刑冲日支：配偶宫受到冲击，婚姻动荡。`,
    pillars: ['日柱', '年柱', '月柱'],
    shishen: ['正财', '偏财', '正官', '七杀', '比肩', '劫财', '食神', '伤官'],
    keywords: ['大运', '流年', '婚姻', '结婚', '离婚', '感情', '恋爱', '第三者', '时机'],
  },
  {
    id: 'bazi-rel-4',
    destinyType: 'bazi',
    subCategory: 'relationship',
    title: '夫妻宫六合六冲与婚姻稳定性',
    content: `【日支六合对婚姻的意义】
日支六合：
子丑合（土）、寅亥合（木）、卯戌合（火）、辰酉合（金）、巳申合（水）、午未合（土）

日支与配偶出生年支相合：感情自然融洽，两人有天然亲和力，婚姻稳固。
命中配偶星（男看财星、女看官星）遇合：感情有深度，不易分离。
日支与流年地支相合：该年感情有重大进展，适合确定关系或结婚。

【日支六冲对婚姻的意义】
日支六冲：子午冲、丑未冲、寅申冲、卯酉冲、辰戌冲、巳亥冲

日支自冲（生年支与日支相冲）：婚姻中自身内心矛盾，或与配偶三观差异大。
流年冲日支：该年婚姻有重大变动（结婚或离婚），婚姻关键年份。
大运冲日支：该大运10年内婚姻面临挑战，需主动维护感情。

【判断婚姻稳定性的综合法】
日支无刑冲合破：婚姻基础稳定，配偶宫安静。
日支有贵人星（天乙贵人）：贵人助婚，婚姻有贵人扶持。
日支被冲同时有合：冲而有合，有危机但有化解，婚姻经历波折后可稳定。`,
    pillars: ['日柱'],
    shishen: ['正财', '偏财', '正官', '七杀'],
    keywords: ['夫妻宫', '六合', '六冲', '日支', '婚姻稳定', '感情', '结婚', '离婚'],
  },
  {
    id: 'bazi-rel-5',
    destinyType: 'bazi',
    subCategory: 'relationship',
    title: '伤官见官与感情问题',
    content: `【伤官见官的感情影响】
伤官（克官）：女命命中伤官旺，官星（夫星）受到克制，感情上容易出现波折。

伤官旺且官星弱：夫星力量弱，婚姻容易出现丈夫能力受限或感情不稳。
伤官透干+官星有力：既有才华独立，又有正式婚姻，但感情磨合多。
伤官透干+无官星：感情中不受约束，自由恋爱，晚婚或婚姻不入心。

【伤官见官的化解方法】
有食神制伤官：减弱伤官的克官力量，婚姻趋于稳定。
印星化伤官：印克食伤，伤官力量受制，官星相对安全，婚姻可稳。
官杀两透（七杀旺）：七杀有力，伤官未能完全克制，但感情仍较复杂。

【男命食神与感情】
男命食神旺：性格随和，情感细腻，但对感情主动性不足，易等待对方主动。
男命食神旺+无偏财：感情专一，但感情节奏较慢，适合慢热型发展。
男命食神生财+财旺：感情随财运而来，事业顺时感情也顺。`,
    shishen: ['伤官', '正官', '七杀', '食神', '正印', '偏印'],
    keywords: ['伤官见官', '感情', '婚姻', '女命', '伤官', '官星', '化解', '食神'],
  },
];

export function retrieve(chartText: string, query: string): KnowledgeEntry[] {
  const keywords = extractKeywords(chartText + ' ' + query);
  return relationshipKnowledge
    .filter(e => matchKeywords(e, keywords))
    .slice(0, 5);
}

export const entries = relationshipKnowledge;

function extractKeywords(text: string): string[] {
  return [
    '婚姻', '感情', '男命', '女命', '妻星', '夫星', '官星', '财星',
    '配偶', '恋爱', '结婚', '离婚', '大运', '流年',
  ].filter(k => text.includes(k));
}

function matchKeywords(entry: KnowledgeEntry, keywords: string[]): boolean {
  if (keywords.length === 0) return true;
  return keywords.some(kw =>
    entry.keywords.includes(kw) || entry.content.includes(kw) || entry.title.includes(kw)
  );
}
